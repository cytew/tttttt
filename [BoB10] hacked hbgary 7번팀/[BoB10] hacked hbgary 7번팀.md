# [BoB10] hacked hbgary 7번팀

## 목차

---

- 해킹 이유
- HBGary의 문제점
- 기술적 문제
- 실무자가 원한 기능

## 해킹 이유

---

### 배경

Wikleaks는 비영리 단체로 외부에서 후원을 받으면서 운영되고 있었는데 페이팔, 뱅크아메리카 등 금융업체가 Wikileaks를 후원하는 계좌를 동결시켰다. 어나니머스는 이에 대한 보복으로 몇몇 금융회사를 대상으로 **DDoS 공격을 수행한 사례가 있다.**

### 발단

- HBGary Federal의 CEO인 Aaron Barr는 2월 5일 <파이낸셜 타임즈>와의 인터뷰에서 자신이 2010년 12월에 어나니머스의 DDoS 공격 이후부터 어나니머스의 **네트워크에 잠입해 일종의 일원처럼 행동했다고 이야기했다.**
- 어나니머스 멤버들의 대화 내용을 트워터나 페이스북 메시지와 대조해 일치하는 부분을 추려내는 방식으로 작업한 끝에 어나니머스는 10~30명 사이의 위계 조직이며 몇몇 **핵심 멤버의 신원을 파악**했다는 이야기를 했다. 그리고 이 정보를 이용해서 **집행 당국이 이들을 체포할 수 있을 것이라 전했다.**

### 결과

Aaron의 이메일과 SNS, 회사 내부 문건이 해킹되었고 **HBGary Federal의 홈페이지를 해킹하여 홈페이지에 메시지를 작성했다.** 메시지에는 Aaron이 어나니머스의 파급력을 이용해서 기업 이미지를 좋게 만들려고 하고 이것이 좋은 사업이 될 것 같다는 대화를 주고받았던 내용이 포함되어 있었다.

홈페이지 이외에도 2월 5일과 6일 총 이틀에 걸쳐 해킹 공격을 했다. 이 기간 동안 Aaron의 SNS계정과 이메일뿐만 아니라 집 주소, 핸드폰 번호, 사회보장번호 등의 신상정보까지 공경의 대상이 되었다. 그리고 **회사 시스템에 직접 침투하여 백업 파일을 모두 삭제하고 회사 이메일 6만여 건을 빼낸 뒤에 PirateBay에 토렌트 파일로 올렸다.** 

어나니머스가 폭로한 자료 중에는 Wikileaks의 기부 계좌를 동결하는 과정에서 Aaron이 사업계획서를 작성하여 뱅크아메리카에 제출했다는 것이 밝혀졌다. 이 문건들은 고객들에게 예민한 내용을 담고 있고 불법행위를 조장하고 있다는 것이 밝혀졌다.

이 공격을 계기로 **회사는 반 폐업 상태**로 이어졌고 **Aaron은 CEO에서 해임**되었으며 어나니머스에 관한 자신의 주장을 후회한다고 밝혔다.

## HBGary의 문제점

---

1. HBGary Federal은 자체 개발한 CMS 웹 페이지를 사용하고 있었다. 당시 많은 웹 사이트들은 **SQL Query를 코드 상에서 하드 코딩하여 많이 사용**했는데 HBGary Federal에서 운영하는 CMS와 웹 페이지에서도 사용자의 입력값 도는 파라미터 값에 대한 **유효성 검사 로직이 제대로 구현되어 있지 않았다.**
2. hbgaryfedral.com의 CMS에서 해시 알고리즘으로 MD5를 사용하고 있었다. 모든 해시 함수는 충돌을 가지고 있고 이 충돌 저항성을 높이기 위해 충분한 길이의 메시지 다이제스트가 필요한데 **MD5의 메시지 다이제스트 길이는 충돌 저항성을 높이기엔 짧은 길이**를 가지고 있다.
3. HBGary 해킹 사건과 연관이 깊은 Aaron과 Ted가 아주 일관되게 암호를 사용했다. 이메일, 트위터, LinkedIn을 포함하여 **여러 곳에서 같은 암호를 사용했다**. 
4. 중요한 기능에 접근 권한을 **단순히 메일로만 상대방을 확인**하여 수석 보안 전문가 Jussi(root)가 Gerg 사칭을 하는 룰즈섹에게 넘어가 [Roolkit.com](http://roolkit.com)으로 접근하는 통로를 열어주었다.

## 기술적 문제

---

### SQL Injection - 발생 원인

룰즈섹이 공격한 HBGary Federal의 CMS를 사용할 당시 많은 웹 사이트들이 **SQL 쿼리 구문을 하드 코딩하여 사용하고 있었다.** 사용자의 입력 값을 전송하는 폼이나 URL 매개변수 등 서버로 전송되는 값에 대한 **유효성 검사 로직이 제대로 구현되어 있지 않았다. 이로 인해** SQL 쿼리 구문에 정상적인 흐름을 방해하는 쿼리를 삽입 시켜 공격자의 의도대로 흐름을 바꿀 수 있게 되었다.

### 해시 함수의 특징

- 암호학적 해시함수는 메시지의 무결성을 제공한다.
- 암호학적 해시 함수를 통해 **메시지 다이제스트**틀 생성하는데 메세지 다이제스트는 고정 길이로 생성 된다. 메세지가 해시 함수를 거쳐 **메시지 다이제스트**가 생성되고 이를 비교하여 메시지의 변조 여부를 확인한다.

![%5BBoB10%5D%20hacked%20hbgary/Untitled.png](%5BBoB10%5D%20hacked%20hbgary/Untitled.png)

- 해시 함수는 일방향성으로 메시지로부터 해시 값은 계산할 수 있지만 **해시 값으로부터 메시지를 계산할 수 없다.**

### MD5가 취약한 이유

모든 해시 함수는 충돌을 가지고 있고 이 충돌 저항성을 피하기 위해 충분한 길이의 메시지 다이제스트가 필요하다. MD5는 입력 메시지를 512비트의 블록으로 나누고, 128비트이 **메시지 다이제스트**를 출력한다. MD5의 메시지 다이제스트 길이는 **충돌 저항성을 높이기엔 짧은 길이**이다.

MD5는 메시지 다이제스트의 길이가 충분하지 않기 때문에 레인보우 테이블이 많이 만들어져 있으며 **Birthday Attack**에도 취약할 수 있다. **Birthday Attack**은 **Birthday Pardaox**를 이용한 공격이다. **Birthday Pardaox**란 교실 안에 학생 K명이 있을 때 **두 학생의 생일이 같을 확률이 P≥1/2 이려면 k는 23이면 된다는 역설**이다. **Birthday Attack**을 128비트의 메시지 다이제스트를 출력하는 MD5 해시함수에 적용시키면 2^128 가지의 경우의 수보다 훨씬 적은 **2^64가지의 경우의 수만 조사하면 된다**. 

MD5는 충돌을 많이 가지고 있으며 일방향 해시 함수임에도 불구하고 해독까지 가능한 안전하지 않은 해시 함수이다. HBGary에서는 이 취약한 **MD5 해시 함수를 사용함**으로써 **보안에 결함**이 생긴 것이다.

### 같은 암호 사용의 위험성 - Ted Vera

HBGary는 [hbgaryfederal.com](http://hbgrayfederal.com)  외에 고객 지원 도메인인 [support.hbgary.com](http://support.hbgary.com)를 가지고 있었다.

[support.hbgary.com](http://support.hbgary.com)이 구동되는 서버는 리눅스 시스템으로 모든 직원이 계정을 가지며 **SSH를 통해 접속이 가능했다.**

Ted Vera는 해당 **SSH 비밀번호를 유추된 비밀번호와 동일한 비밀번호로 사용하고 있었다.** 따라서 룰즈섹은 일반 사용자 권한으로 해당 서버에 접속이 가능했다.

룰즈섹은 커널 1-day 취약점(CVE-2010-3847)으로 이용해 **Privilege Escalation에 성공했다.**

root 권한을 탈취한 룰즈섹은 백업 데이터와 연구 데이터를 시스템에서 찾고 완전히 삭제했다.

### 같은 암호 사용의 위험성 - Aaron Barr

Aaron Barr는 유출된 비밀번호를 구글 메일에서 동일하게 사용했다. Aaron Barr는 CEO로서 회사 메일의 최고 관리자 권한을 가지고 있었다. 룰즈섹은 회사의 모든 메일에 접근할 수 있게 되었고 Greg를 사칭하여 [Roolkit.com](http://roolkit.com)에 접근할 수 있게 되었다.

### 사회공학적 기법 사용

![%5BBoB10%5D%20hacked%20hbgary/Untitled%201.png](%5BBoB10%5D%20hacked%20hbgary/Untitled%201.png)

룰즈섹은 Aaron의 계정을 통해 Greg의 메일 함에 접근해 루트 암호와 보안 전문가 Jussi Jakkonaho가 루트 접근 권한을 가지고 있다는 **정보를 알아냈다.**

보안 절차로 인해 루트 계정에서 직접 SSH 접근은 불가능했기에 
룰즈섹은 Greg를 사칭하여 Jussi에게 계정과 암호를 알고 있다는 사실을 이용해 [Roolkit.com](http://roolki.com)에 접근할 수 있는 통로를 열어달라고 메일을 보냈다. Jussi는 메일로 상대방을 확인해 [**Rootkit.com](http://rootkit.com)에 접근할 수 있는 통로를 열어주었다.**

![%5BBoB10%5D%20hacked%20hbgary/Untitled%202.png](%5BBoB10%5D%20hacked%20hbgary/Untitled%202.png)

## 실무자가 원한 기능

---

### 실무자가 제품을 구매한 이유

- Runtime Analysis 기능을 사용하기 위해서였다.
- HBGary 메인 사이트 하단 동영상 다운로드 링크에 Runtime Malware Analysis라는 문구가 보였었다.
- Blackhat 2007 - Active Reversing 발표의 PPT 슬라이드에 Runtime Analysis가 있었다.

### 문제 발생

제품을 구매하고 "HBGary Responder v1.2 User Guide.pdf" 매뉴얼을 읽고 과정을 따라 해보았지만 Analyze Binary 후 Globval 섹션을 획득할 수 없었다.

### HBGary와 의사소통

문제가 발생하여 HBGary와 여러 번 메일을 주고받았으며 다양한 환경에서 Responder의 Runtime Analysis  기능을 시도해 보았지만 모두 실패하였다. (Windows 2003 SP1 Ko, Windows XP SP2 En, Windows XP SP3 En, Windows XP SP3 Ko, etc...)

### 정리

실무자는 런타임 중 바이너리를 분석할 수 있는 동적 분석 기능을 원했다. 하지만 설명서대로 여러 시스템에서 테스트해봐도 제대로 동작하지 않았다. HBGary에 메일을 보냈지만 답장도 없었고 패치도 이루어지지 않았다.